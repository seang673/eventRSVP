package com.example.demo.controller;


@RestController
@RequestMapping("/api/profile")
public class ProfileController {

    private final EventRepository eventRepository;
    private final RsvpRepository rsvpRepository;

    public ProfileController(EventRepository eventRepository, RsvpRepository rsvpRepository) {
        this.eventRepository = eventRepository;
        this.rsvpRepository = rsvpRepository;
    }

    @GetMapping("/organizer")
    public ResponseEntity<?> getOrganizerProfile(HttpServletRequest request) {

        Boolean isOrganizer = (Boolean) request.getAttribute("isOrganizer");
        Long userId = (Long) request.getAttribute("userId");

        if (!isOrganizer) {
            return ResponseEntity.status(HttpStatus.FORBIDDEN)
                    .body("Only organizers can access this endpoint");
        }

        // 1. Fetch all events created by this organizer
        List<Event> events = eventRepository.findByOrganizerId(userId);

        // 2. Fetch all RSVPs for those events
        List<Long> eventIds = events.stream()
                .map(Event::getId)
                .toList();

        List<Rsvp> rsvps = rsvpRepository.findByEventIdIn(eventIds);

        Map<String, Object> response = new HashMap<>();
        response.put("events", events);
        response.put("rsvps", rsvps);

        return ResponseEntity.ok(response);
    }


    @GetMapping("/attendee")
    public ResponseEntity<?> getAttendeeProfile(HttpServletRequest request) {
        System.out.println("ATTENDEE PROFILE HIT");
        Boolean isOrganizer = (Boolean) request.getAttribute("isOrganizer");
        Long userId = (Long) request.getAttribute("userId");

        // Attendees only â€” organizers shouldn't hit this
        if (isOrganizer) {
            return ResponseEntity.status(HttpStatus.FORBIDDEN)
                    .body("This profile is for attendees");
        }

        List<Rsvp> rsvps = rsvpRepository.findByUserId(userId);

        return ResponseEntity.ok(rsvps);
    }
}